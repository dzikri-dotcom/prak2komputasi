pipeline {
    agent any

    environment {
        IMAGE_NAME = 'dzikri2811/simple-app'
        REGISTRY_CREDENTIALS = 'dockerhub-credentials'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'üîπ Mengambil source code dari GitHub...'
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('simple-app') {
                    echo 'üê≥ Membangun Docker image...'
                    bat 'docker build -t %IMAGE_NAME%:%BUILD_NUMBER% .'
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                dir('simple-app') {
                    echo 'üöÄ Login ke Docker Hub dan push image...'
                    withCredentials([usernamePassword(credentialsId: REGISTRY_CREDENTIALS, usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        bat '''
                        echo Logging in to Docker Hub...
                        docker logout
                        docker login -u "%DOCKER_USER%" -p "%DOCKER_PASS%"
                        if %errorlevel% neq 0 exit /b %errorlevel%
                        
                        echo ‚úÖ Login berhasil, push image...
                        docker push %IMAGE_NAME%:%BUILD_NUMBER%
                        if %errorlevel% neq 0 exit /b %errorlevel%
                        
                        docker tag %IMAGE_NAME%:%BUILD_NUMBER% %IMAGE_NAME%:latest
                        docker push %IMAGE_NAME%:latest
                        if %errorlevel% neq 0 exit /b %errorlevel%
                        '''
                    }
                }
            }
        }
    }

    post {
        success {
            bat 'echo ‚úÖ Build dan Push Docker Image berhasil!'
        }
        failure {
            bat 'echo ‚ùå Build gagal, periksa log untuk detail error.'
        }
    }
}
