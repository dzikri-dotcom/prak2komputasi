pipeline {
  agent any

  environment {
    // Nama image Docker yang akan dibangun dan di-push ke Docker Hub
    IMAGE_NAME = 'yourdockerusername/simple-app'
    // ID credential Docker Hub di Jenkins
    REGISTRY_CREDENTIALS = 'dockerhub-credentials'
  }

  stages {
    stage('Checkout') {
      steps {
        echo 'ğŸ”¹ Mengambil source code dari GitHub...'
        checkout scm
      }
    }

    stage('Build') {
      steps {
        bat 'echo "ğŸ—ï¸  Build di Windows dimulai..."'
      }
    }

    stage('Build Docker Image') {
      steps {
        echo 'ğŸ³ Membangun Docker image dari folder simple-app...'
        // Dockerfile berada di folder simple-app
        bat 'docker build -f simple-app/Dockerfile -t %IMAGE_NAME%:%BUILD_NUMBER% simple-app'
      }
    }

    stage('Push Docker Image') {
      steps {
        echo 'ğŸš€ Login ke Docker Hub dan push image...'
        withCredentials([usernamePassword(
          credentialsId: REGISTRY_CREDENTIALS,
          usernameVariable: 'USER',
          passwordVariable: 'PASS'
        )]) {
          // Login ke Docker Hub menggunakan username & token
          bat 'docker login --username %USER% --password %PASS%'
          
          // Push image dengan tag build number
          bat 'docker push %IMAGE_NAME%:%BUILD_NUMBER%'
          
          // Tambahkan tag latest dan push juga
          bat 'docker tag %IMAGE_NAME%:%BUILD_NUMBER% %IMAGE_NAME%:latest'
          bat 'docker push %IMAGE_NAME%:latest'
        }
      }
    }
  }

  post {
    always {
      bat 'echo "âœ… Pipeline selesai dijalankan."'
    }
    success {
      bat 'echo "ğŸ‰ Build dan Push Docker Image berhasil!"'
    }
    failure {
      bat 'echo "âŒ Build gagal, periksa log untuk detail error."'
    }
  }
}
