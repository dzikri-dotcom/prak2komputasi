pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "dzikri2811/simple-app:latest"
        DOCKER_CREDENTIALS = "dockerhub-credentials"
    }

    stages {
        stage('Checkout') {
            steps {
                echo "üîπ Mengambil source code dari GitHub..."
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                echo "üê≥ Membangun Docker image..."
                bat 'docker build -f simple-app/Dockerfile -t %DOCKER_IMAGE% simple-app'
            }
        }

        stage('Push Docker Image') {
            steps {
                echo "üöÄ Login ke Docker Hub dan push image..."
                withCredentials([usernamePassword(credentialsId: "${DOCKER_CREDENTIALS}", usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                    bat '''
                    docker logout
                    docker login -u "%DOCKER_USER%" -p "%DOCKER_PASS%"
                    if %errorlevel% neq 0 exit /b %errorlevel%

                    docker push %DOCKER_IMAGE%
                    if %errorlevel% neq 0 exit /b %errorlevel%
                    '''
                }
            }
        }
    }

    post {
        success {
            bat 'echo ‚úÖ Build dan Push Docker Image berhasil!'
        }
        failure {
            bat 'echo ‚ùå Build gagal, periksa log untuk detail error.'
        }
    }
}
