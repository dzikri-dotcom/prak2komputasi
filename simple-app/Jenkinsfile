pipeline {
    agent any

    environment {
        IMAGE_NAME = 'dzikri2811/simple-app'
        REGISTRY_CREDENTIALS = 'dockerhub-credentials'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'üîπ Mengambil source code dari GitHub...'
                // Karena Jenkinsfile ada di dalam simple-app, checkout dari root repo tetap berlaku
                checkout scm
                // Pindah ke folder simple-app
                dir('simple-app') {
                    bat 'echo üìÇ Berpindah ke folder simple-app...'
                }
            }
        }

        stage('Build') {
            steps {
                dir('simple-app') {
                    bat 'echo üèóÔ∏è  Build di Windows dimulai...'
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('simple-app') {
                    echo 'üê≥ Membangun Docker image...'
                    bat 'docker build -t %IMAGE_NAME%:%BUILD_NUMBER% .'
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                dir('simple-app') {
                    echo 'üöÄ Login ke Docker Hub dan push image...'
                    withCredentials([usernamePassword(credentialsId: REGISTRY_CREDENTIALS, usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                        bat '''
                        echo Logging in to Docker Hub...
                        docker logout
                        docker login -u %USER% -p %PASS%
                        docker push %IMAGE_NAME%:%BUILD_NUMBER%
                        docker tag %IMAGE_NAME%:%BUILD_NUMBER% %IMAGE_NAME%:latest
                        docker push %IMAGE_NAME%:latest
                        '''
                    }
                }
            }
        }
    }

    post {
        always {
            bat 'echo ‚úÖ Pipeline selesai dijalankan.'
        }
        failure {
            bat 'echo ‚ùå Build gagal, periksa log untuk detail error.'
        }
    }
}
